<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WabiSaby</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="alternate icon" href="assets/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preload" href="assets/startup-sound.mp3" as="audio" crossorigin="anonymous">
    <script src="js/core/startup-sound.js"></script>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-leaf fa-3x pulse-icon"></i>
            </div>
            <h1 class="loading-title">Wabi<span class="highlight">Saby</span></h1>
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p class="loading-message" id="loading-message">Checking authentication...</p>
        </div>
    </div>

    <script>
        const pageLoadStartTime = Date.now();
        
        const loadingMessageEl = document.getElementById('loading-message');
        
        // Initialize startup sound (with completion tracking for redirect delays)
        if (window.StartupSound) {
            window.StartupSound.init('assets/startup-sound.mp3', { waitForCompletion: true });
        }
        
        function updateLoadingMessage(text) {
            if (!loadingMessageEl) return;
            
            loadingMessageEl.classList.add('updating');
            setTimeout(() => {
                loadingMessageEl.textContent = text;
                loadingMessageEl.classList.remove('updating');
            }, 150);
        }
        
        async function redirectWhenReady(url, finalMessage) {
            // Wait for both: sound to finish AND ensure we have data
            const promises = [];
            
            // Wait for sound to finish
            if (window.StartupSound) {
                promises.push(window.StartupSound.waitForCompletion());
            }
            
            // Wait for all promises (sound completion)
            await Promise.all(promises);
            
            // Show final message briefly if provided
            if (finalMessage && loadingMessageEl) {
                updateLoadingMessage(finalMessage);
                // Small delay to show the message (200ms is enough for UX)
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Redirect immediately after sound finishes
            window.location.replace(url);
        }

        (async function() {
            updateLoadingMessage('Initializing WabiSaby...');
            
            try {
                updateLoadingMessage('Connecting to WabiSaby server...');
                
                const response = await fetch('/api/status');
                
                updateLoadingMessage('Checking WhatsApp connection status...');
                
                const data = await response.json();
                
                if (data.auth && typeof data.auth.isConnected === 'boolean') {
                    if (data.auth.isConnected === true) {
                        updateLoadingMessage('WhatsApp connected!');
                        // Redirect immediately after sound finishes (no artificial delay)
                        redirectWhenReady('/pages/dashboard.html', 'Welcome back!');
                    } else {
                        if (data.auth.qr) {
                            updateLoadingMessage('QR code received from WhatsApp...');
                        } else {
                            updateLoadingMessage('Connecting to WhatsApp servers...');
                        }
                        // Redirect immediately after sound finishes (no artificial delay)
                        redirectWhenReady('/pages/auth.html', 'Ready to connect...');
                    }
                } else {
                    updateLoadingMessage('Initializing WhatsApp connection...');
                    
                    // Wait for sound, then reload
                    if (window.StartupSound) {
                        await window.StartupSound.waitForCompletion();
                    }
                    // Small delay to show message
                    await new Promise(resolve => setTimeout(resolve, 300));
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                updateLoadingMessage('Error connecting to server. Retrying...');

                // Wait for sound, then reload
                if (window.StartupSound) {
                    await window.StartupSound.waitForCompletion();
                }
                // Small delay to show error message
                await new Promise(resolve => setTimeout(resolve, 500));
                window.location.reload();
            }
        })();
    </script>
</body>
</html>
